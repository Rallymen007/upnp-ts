"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const dgram_1 = require("dgram");
const events_1 = require("events");
const buffer_1 = require("buffer");
const device_1 = require("./device");
const SSDP_PORT = 1900;
const BROADCAST_ADDR = "239.255.255.250";
class SSDP extends events_1.EventEmitter {
    constructor(_debug, _ip) {
        super();
        this._debug = _debug;
        this._ip = _ip;
        this._skt = dgram_1.createSocket({ type: 'udp4', reuseAddr: true }, (msg, rinfo) => {
            this.processMessage(msg.toString(), rinfo);
        });
        this._skt.on('listening', () => {
            super.emit('ready');
        });
        this._skt.on('error', (err) => {
            console.warn('socket error', err);
        });
        this._skt.bind(SSDP_PORT, this._ip, () => {
            this._skt.addMembership(BROADCAST_ADDR, this._ip);
        });
    }
    headersToObj(headers) {
        let ret = [];
        let lines = headers.split("\r\n");
        for (let line of lines) {
            if (line != "" && line.indexOf(":") > 0) {
                ret[line.substr(0, line.indexOf(":")).toUpperCase().trim()] = line.substr(line.indexOf(':') + 1).trim();
            }
            else if (line != '') {
                ret['RESPONSE-TYPE'] = line.substr(0, line.indexOf(" ")).trim().toUpperCase();
            }
        }
        return ret;
    }
    processMessage(msg, info) {
        let res = this.headersToObj(msg);
        if (res['LOCATION']) {
            let d = new device_1.Device((d) => { this._debug(d); }, this._ip, res, info);
            d.discover(() => {
                super.emit('device', d);
            });
        }
    }
    search(st) {
        try {
            let buf = new buffer_1.Buffer("M-SEARCH * HTTP/1.1\r\n" +
                "HOST: " + BROADCAST_ADDR + ":" + SSDP_PORT + "\r\n" +
                "MAN: \"ssdp:discover\"\r\n" +
                "MX: 1\r\n" +
                "ST: " + st + "\r\n" +
                "USER-AGENT: nodejs/" + process.version + " UPnP/2.0 draketv/2.0\r\n\r\n", 'utf8');
            let skt2 = dgram_1.createSocket({ type: 'udp4', reuseAddr: true }, (msg, rinfo) => {
                this.processMessage(msg.toString(), rinfo);
            });
            skt2.on('error', (err) => {
                console.warn('skt2 error', err);
            });
            skt2.on('listening', () => {
                this._debug(["SSDP", "SSDP2 listening on ", skt2.address().address, skt2.address().port]);
                skt2.send(buf, 0, buf.length, SSDP_PORT, BROADCAST_ADDR, (err) => {
                    setTimeout(() => {
                        skt2.close();
                        this._debug(["SSDP", 'closing down requesting socket']);
                    }, 3000);
                });
            });
            skt2.bind(undefined, this._ip, () => {
                skt2.addMembership(BROADCAST_ADDR, this._ip);
            });
        }
        catch (e) {
            console.warn("Unhandled socket exception", e);
        }
    }
}
exports.SSDP = SSDP;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3NkcC5qcyIsInNvdXJjZVJvb3QiOiJEOi9kZXYvbm9kZV9wcm9qZWN0cy91cG5wL3NyYy8iLCJzb3VyY2VzIjpbInNzZHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBNkM7QUFDN0MsbUNBQXNDO0FBQ3RDLG1DQUFnQztBQUNoQyxxQ0FBaUM7QUFFakMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDO0FBQ3ZCLE1BQU0sY0FBYyxHQUFHLGlCQUFpQixDQUFDO0FBRXpDLFVBQWtCLFNBQVEscUJBQVk7SUFFbEMsWUFBb0IsTUFBeUIsRUFBVSxHQUFXO1FBQzlELEtBQUssRUFBRSxDQUFDO1FBRFEsV0FBTSxHQUFOLE1BQU0sQ0FBbUI7UUFBVSxRQUFHLEdBQUgsR0FBRyxDQUFRO1FBRTlELElBQUksQ0FBQyxJQUFJLEdBQUcsb0JBQVksQ0FBQyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxFQUFHLENBQUMsR0FBVyxFQUFFLEtBQVU7WUFDbEYsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDOUMsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxXQUFXLEVBQUU7WUFDdEIsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN4QixDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLEdBQU87WUFDMUIsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDdEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUdqQyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLEVBQUUs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